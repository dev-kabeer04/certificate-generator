{% extends "base.html" %}

{% block title %}Generate Certificates{% endblock %}

{% block head %}
<style>
.upload-method-tabs { display:flex; gap:10px; margin-bottom:20px; border-bottom:2px solid #E5E7EB; }
.tab-button { padding:12px 24px; background:none; border:none; border-bottom:3px solid transparent; cursor:pointer; font-size:16px; font-weight:500; color:#6B7280; transition:all .3s; }
.tab-button.active { color:#4C51BF; border-bottom-color:#4C51BF; }
.tab-button:hover { color:#4C51BF; }
.tab-content { display:none; }
.tab-content.active { display:block; }
.csv-template-info { background:#FEF3C7; border-left:4px solid #F59E0B; padding:15px; border-radius:5px; margin-bottom:20px; }
.csv-template-info h4 { color:#92400E; margin-bottom:10px; font-size:16px; }
.csv-template-info p { color:#78350F; font-size:14px; margin-bottom:8px; }
.csv-example { background:white; padding:10px; border-radius:5px; font-family:monospace; font-size:13px; color:#1F2937; margin-top:10px; }
.download-template-btn { display:inline-block; margin-top:10px; padding:8px 16px; background:#F59E0B; color:white; text-decoration:none; border-radius:5px; font-size:14px; transition:background .3s; }
.download-template-btn:hover { background:#D97706; }
.email-option, .auto-template-option { background:#EFF6FF; border:2px solid #DBEAFE; padding:15px; border-radius:8px; margin-top:20px; }
.email-option label, .auto-template-option label { display:flex; align-items:center; gap:10px; cursor:pointer; font-weight:600; color:#1E40AF; }
.email-option input[type="checkbox"], .auto-template-option input[type="checkbox"] { width:20px; height:20px; cursor:pointer; }
.email-warning { background:#FEF2F2; border-left:4px solid #EF4444; padding:12px; border-radius:5px; margin-top:10px; font-size:13px; color:#991B1B; }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
  <h2>Generate Certificates</h2>
</div>

<div style="max-width: 900px; margin: 0 auto;">
  <form method="POST" enctype="multipart/form-data" style="background:#F9FAFB; padding:20px; border-radius:10px;">
    
    <!-- Course Selection -->
    <div class="form-group">
      <label for="course_id">Select Course *</label>
      <select id="course_id" name="course_id" required onchange="updateCourseName()">
        <option value="">-- Select a course --</option>
        {% for c in courses or [] %}
          <option value="{{ c.id }}" data-name="{{ c.name }}">{{ c.name }} ({{ c.code }})</option>
        {% endfor %}
      </select>
      <p style="font-size:12px; color:#6B7280; margin-top:5px;">
        Don‚Äôt see your course? <a href="{{ url_for('manage_courses') }}" style="color:#4C51BF;">Add it here</a>
      </p>
    </div>

    <input type="hidden" id="course_name" name="course_name">

    <!-- Template Selection -->
    <div class="form-group">
      <label for="template_id">Select Template *</label>
      <select id="template_id" name="template_id" required>
        <option value="">-- Select a template --</option>
        {% for t in templates or [] %}
          <option value="{{ t.id }}">{{ t.name }}</option>
        {% endfor %}
      </select>
      <p style="font-size:12px; color:#6B7280; margin-top:5px;">
        Want a custom design? <a href="{{ url_for('manage_templates') }}" style="color:#4C51BF;">Create template here</a>
      </p>
    </div>

    <!-- Auto Template -->
    <div class="auto-template-option">
      <label>
        <input type="checkbox" id="auto_template" name="auto_template">
        üé® Auto-select template based on percentage (if applicable)
      </label>
      <p style="font-size:13px; color:#1E40AF; margin:10px 0 0 30px;">
        The system will choose the best template automatically based on the recipient‚Äôs course result percentage.
      </p>
    </div>

    <!-- Issue Date -->
    <div class="form-group">
      <label for="issue_date">Issue Date *</label>
      <input type="date" id="issue_date" name="issue_date" required>
    </div>

    <!-- Upload Method Tabs -->
    <div class="form-group">
      <label>Recipients Input Method</label>
      <div class="upload-method-tabs">
        <button type="button" class="tab-button active" onclick="switchTab(event,'manual')">‚úçÔ∏è Manual Entry</button>
        <button type="button" class="tab-button" onclick="switchTab(event,'csv')">üìÑ CSV Upload</button>
      </div>

      <!-- Manual Entry Tab -->
      <div id="manual-tab" class="tab-content active">
        <textarea id="names" name="names" placeholder="One per line. Examples:
John Doe
Jane Smith,jane@example.com
Bob Brown <bob@school.edu>" style="min-height:150px;"></textarea>
        <p style="font-size:14px; color:#6B7280; margin-top:5px;">
          Include emails inline using <code>Name,email</code> or <code>Name &lt;email&gt;</code>. 
          Check ‚ÄúSend certificates via email automatically‚Äù to email these entries.
        </p>
      </div>

      <!-- CSV Upload Tab -->
      <div id="csv-tab" class="tab-content">
        <div class="csv-template-info">
          <h4>üìã CSV Format Requirements</h4>
          <p><strong>Required:</strong> name</p>
          <p><strong>Optional:</strong> email (needed for email sending)</p>
          <div class="csv-example">
            <strong>Example CSV:</strong><br>
            name,email<br>
            John Doe,john@example.com<br>
            Jane Smith,jane@example.com
          </div>
          <a href="data:text/csv;charset=utf-8,name,email%0AJohn Doe,john@example.com%0AJane Smith,jane@example.com"
             download="certificate_template.csv"
             class="download-template-btn">‚¨áÔ∏è Download CSV Template</a>
        </div>
        <input type="file" id="csv_file" name="csv_file" accept=".csv">
      </div>
    </div>

    <!-- Email Option -->
    <div class="email-option">
      <label>
        <input type="checkbox" id="send_emails" name="send_emails">
        üìß Send certificates via email automatically
      </label>
      <p style="font-size:13px; color:#1E40AF; margin:10px 0 0 30px;">
        Certificates will be emailed if email addresses are provided.
      </p>
      <div class="email-warning" id="email-warning" style="display:none; margin-left:30px;">
        ‚ö†Ô∏è Email settings must be configured first.
        <a href="{{ url_for('email_settings') }}" style="color:#DC2626; text-decoration:underline;">Configure email settings</a>
      </div>
    </div>

    <!-- Submit Buttons -->
    <div class="btn-group" style="margin-top:20px;">
      <button type="submit" class="btn btn-primary">Generate Certificates</button>
      <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Cancel</a>
    </div>
  </form>

  <!-- Tips -->
  <div style="margin-top:30px; padding:20px; background:#EFF6FF; border-left:4px solid #3B82F6; border-radius:5px;">
    <h4 style="color:#1E40AF; margin-bottom:10px; font-size:16px;">üí° Tips</h4>
    <ul style="color:#1E3A8A; padding-left:20px; font-size:14px; line-height:1.8;">
      <li><strong>Manual Entry:</strong> best for small batches; supports inline emails.</li>
      <li><strong>CSV Upload:</strong> ideal for large batches with emails.</li>
      <li><strong>Email Distribution:</strong> auto-sends certificates to recipients.</li>
      <li>Each certificate has a unique ID and QR code for verification.</li>
    </ul>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const issueDateEl = document.getElementById('issue_date');
if (issueDateEl) issueDateEl.valueAsDate = new Date();

function updateCourseName() {
  const sel = document.getElementById('course_id');
  const opt = sel && sel.options[sel.selectedIndex];
  const hidden = document.getElementById('course_name');
  if (hidden) hidden.value = opt ? (opt.getAttribute('data-name') || '') : '';
}

function switchTab(e, tab) {
  document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
  e.target.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  const target = document.getElementById(tab + '-tab');
  if (target) target.classList.add('active');
  // Clear the other input
  if (tab === 'manual') document.getElementById('csv_file').value = '';
  else document.getElementById('names').value = '';
}

const sendBox = document.getElementById('send_emails');
const warn = document.getElementById('email-warning');
if (sendBox && warn) {
  sendBox.addEventListener('change', () => { warn.style.display = sendBox.checked ? 'block' : 'none'; });
}
</script>
{% endblock %}
